import os

from telebot import TeleBot
from telebot.types import Message
import sqlite3
import threading
from date_formatter import format_date_russian


class MafiaBot:
    def __init__(self, token: str):
        self.bot = TeleBot(token)
        self.conn = sqlite3.connect('../event.db', check_same_thread=False, timeout=10)
        self.lock = threading.Lock()
        self.create_tables()
        self.setup_handlers()
        self.date = 'default date'
        self.time = '18:00'
        self.location = 'https://maps.app.goo.gl/LLHVqSW4Do9ALm5R8?g_st=atm'
        self.registration_open = False

    def is_group_admin(self, chat_id: int, user_id: int) -> bool:
        try:
            chat_member = self.bot.get_chat_member(chat_id, user_id)
            return chat_member.status in ['creator', 'administrator']
        except Exception:
            print(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.')
            return False

    def open_registration(self) -> None:
        self.registration_open = True

    def close_registration(self) -> None:
        self.registration_open = False

    def create_tables(self) -> None:
        with self.lock:
            with self.conn:
                cursor = self.conn.cursor()
                cursor.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    user_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    tg_user_id INTEGER UNIQUE,
                    username TEXT
                )
                ''')
                cursor.execute('''
                CREATE TABLE IF NOT EXISTS registrations (
                    registration_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    event_time TEXT,
                    registration_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (user_id) REFERENCES users (user_id)
                )
                ''')
                self.conn.commit()

    def setup_handlers(self) -> None:
        @self.bot.message_handler(func=lambda message: any(keyword in message.text.lower()
                                                           for keyword in ['–º—Ä–∞–∑', '–±–ª—è', '—Ö—É–π', '–ø–∏–∑–¥', '–µ–±–∞']))
        def handle_message(message: Message):
            self.bot.reply_to(message, '–ì—Ä—É–±–∏—è–Ω!')
            return

        @self.bot.message_handler(commands=['start'])
        def handle_start(message: Message):
            self.bot.reply_to(message, '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.')

        @self.bot.message_handler(commands=['help'])
        def handle_help(message: Message):
            self.bot.reply_to(message, '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n'
                                       '/start - –ù–∞—á–∞—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–æ—Ç–æ–º.\n'
                                       '/help - –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.\n'
                                       '/register <–í–∞—à –Ω–∏–∫> - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n'
                                       '/join [–í—Ä–µ–º—è] - –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.\n'
                                       '/open <–î–∞—Ç–∞> [–ú–µ—Å—Ç–æ] [–í—Ä–µ–º—è] - –û—Ç–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.\n'
                                       '/clear - –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.\n'
                                       '/cancel - –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.\n'
                                       '[–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã], <–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã>.')

        @self.bot.message_handler(commands=['register'])
        def handle_register(message: Message):
            try:
                username = message.text.split(maxsplit=1)[1]
                with self.lock:
                    with self.conn:
                        cursor = self.conn.cursor()
                        cursor.execute('''
                        INSERT OR REPLACE INTO users (tg_user_id, username)
                        VALUES (?, ?)
                        ''', (message.from_user.id, username.capitalize()))
                        self.conn.commit()
                self.bot.reply_to(message, f'–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –Ω–∏–∫–æ–º {username.capitalize()}!')
            except IndexError:
                self.bot.reply_to(message, '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /register <–í–∞—à –Ω–∏–∫>.')

        @self.bot.message_handler(commands=['join'])
        def handle_join(message: Message):
            try:
                parts = message.text.split(maxsplit=1)
                if len(parts) == 1:
                    event_time = self.time
                else:
                    event_time = parts[1]
                self.register_for_event(message.from_user.id, event_time, message)
            except IndexError:
                self.bot.reply_to(message, '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /join [–í—Ä–µ–º—è].')

        @self.bot.message_handler(commands=['open'])
        def handle_open(message: Message):
            if not self.is_group_admin(message.chat.id, message.from_user.id):
                self.bot.reply_to(message, '–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã.')
                return
            try:
                data = message.text.split(maxsplit=1)[1]
                self.open_registration()
                data_list = data.split(' ')
                self.date = format_date_russian(data_list[0])
                if len(data_list) > 1:
                    self.location = data_list[1]
                if len(data_list) > 2:
                    self.time = data_list[2]
                self.bot.reply_to(message, f'{self.date}, –ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã—Ç–∞! üòé\n\nüïê {self.time}\nüó∫ {self.location}.')
            except IndexError:
                self.bot.reply_to(message, '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /open <–î–∞—Ç–∞> [–ú–µ—Å—Ç–æ] [–í—Ä–µ–º—è].')

        @self.bot.message_handler(commands=['clear'])
        def handle_clear(message: Message):
            if not self.is_group_admin(message.chat.id, message.from_user.id):
                self.bot.reply_to(message, '–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã.')
                return

            try:
                with self.lock:
                    with self.conn:
                        cursor = self.conn.cursor()
                        cursor.execute('DELETE FROM registrations')
                        self.conn.commit()
                self.bot.reply_to(message, '–°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω!')
            except IndexError:
                self.bot.reply_to(message, f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /clear.')

        @self.bot.message_handler(commands=['cancel'])
        def handle_cancel(message: Message):
            try:
                tg_user_id = message.from_user.id
                self.cancel_registration(tg_user_id, message)
            except IndexError:
                self.bot.reply_to(message, '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /cancel.')

    def register_for_event(self, tg_user_id: int, event_time: str, message: Message) -> None:
        try:
            with self.lock:
                with self.conn:
                    cursor = self.conn.cursor()
                    cursor.execute('''
                    SELECT user_id, username FROM users WHERE tg_user_id = ?
                    ''', (tg_user_id,))
                    user = cursor.fetchone()
                    if not self.registration_open:
                        self.bot.reply_to(message, '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ –Ω–∞ –∏–≥—Ä—ã.')
                        return
                    if user:
                        user_id, username = user
                        cursor.execute('''
                        SELECT * FROM registrations WHERE user_id = ?
                        ''', (user_id,))
                        existing_registration = cursor.fetchone()

                        if existing_registration:
                            cursor.execute('''
                            UPDATE registrations SET event_time = ? WHERE user_id = ?
                            ''', (event_time, user_id))
                        else:
                            cursor.execute('''
                            INSERT INTO registrations (user_id, event_time)
                            VALUES (?, ?)
                            ''', (user_id, event_time))

                        self.conn.commit()

                        cursor.execute('''
                        SELECT u.username, r.event_time
                        FROM registrations r
                        JOIN users u ON r.user_id = u.user_id
                        ORDER BY r.registration_time
                        ''')
                        registrations = cursor.fetchall()

                        registration_list = '\n'.join(
                            [f'{i + 1}. {reg[0]}' + (f' {reg[1]}' if reg[1] != self.time else '') for i, reg in
                             enumerate(registrations)]
                        )

                        self.bot.reply_to(message,
                                          f'{self.date}, –ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã—Ç–∞! üòé\n\n{registration_list}\n\nüïê '
                                          f'{self.time}\nüó∫ {self.location}')
                        if len(registrations) > 12:
                            self.close_registration()
                    else:
                        self.bot.reply_to(message, '–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /register <–í–∞—à –Ω–∏–∫>.')
        except sqlite3.Error:
            self.bot.reply_to(message, f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.')

    def cancel_registration(self, tg_user_id: int, message: Message) -> None:
        try:
            with self.lock:
                with self.conn:
                    cursor = self.conn.cursor()
                    cursor.execute('''
                    SELECT user_id, username FROM users WHERE tg_user_id = ?
                    ''', (tg_user_id,))
                    user = cursor.fetchone()

                    if user:
                        user_id, username = user
                        cursor.execute('''
                        SELECT * FROM registrations WHERE user_id = ?
                        ''', (user_id,))
                        existing_registration = cursor.fetchone()

                        if existing_registration:
                            cursor.execute('''
                            DELETE FROM registrations WHERE user_id = ?
                            ''', (user_id,))
                            self.conn.commit()

                            cursor.execute('''
                            SELECT u.username, r.event_time
                            FROM registrations r
                            JOIN users u ON r.user_id = u.user_id
                            ORDER BY r.registration_time
                            ''')
                            registrations = cursor.fetchall()

                            registration_list = '\n'.join(
                                [f'{i + 1}. {reg[0]}' + (f' {reg[1]}' if reg[1] != self.time else '') for i, reg in
                                 enumerate(registrations)]
                            )

                            self.bot.reply_to(message,
                                              f'{self.date}, –ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã—Ç–∞! üòé\n\n{registration_list}\n\nüïê '
                                              f'{self.time}\nüó∫ {self.location}')
                            if len(registrations) > 12:
                                self.close_registration()
                        else:
                            self.bot.reply_to(message, '–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.')
                    else:
                        self.bot.reply_to(message, '–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.')

        except sqlite3.Error:
            self.bot.reply_to(message, f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.')

    def start_polling(self) -> None:
        print('Running telebot...')
        self.bot.polling(none_stop=True)

    def stop(self) -> None:
        self.conn.close()


if __name__ == '__main__':
    TOKEN = os.getenv('TOKEN')
    bot = MafiaBot(TOKEN)
    try:
        bot.start_polling()
    except KeyboardInterrupt:
        bot.stop()
